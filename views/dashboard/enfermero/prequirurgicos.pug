extends ../../layouts/enfermero-layout

block content
  .container-fluid
    // Header
    .row.mb-4
      .col-12
        .d-flex.justify-content-between.align-items-center
          div
            h2.mb-1
              i.fas.fa-notes-medical.me-2
              | Preparación Pre-quirúrgica
            p.text-muted.mb-0 Gestión de preparaciones para cirugía
          div
            button.btn.btn-outline-danger(onclick='verPendientes()')
              i.fas.fa-exclamation-triangle.me-2
              | Ver Pendientes

    // Estadísticas
    .row.g-3.mb-4
      .col-md-3.col-sm-6
        .card.border-0.shadow-sm.text-center
          .card-body
            h3.mb-0= estadisticas.total
            small.text-muted Total
      
      .col-md-3.col-sm-6
        .card.border-0.shadow-sm.border-start.border-warning.border-4.text-center
          .card-body
            h3.mb-0.text-warning= estadisticas.pendientes
            small.text-muted Pendientes
      
      .col-md-3.col-sm-6
        .card.border-0.shadow-sm.border-start.border-success.border-4.text-center
          .card-body
            h3.mb-0.text-success= estadisticas.completados
            small.text-muted Completados
      
      .col-md-3.col-sm-6
        .card.border-0.shadow-sm.border-start.border-danger.border-4.text-center
          .card-body
            h3.mb-0.text-danger= estadisticas.urgentes
            small.text-muted Urgentes

    // Filtros
    .row.mb-3
      .col-12
        .card.border-0.shadow-sm
          .card-body
            form#form-filtros.row.g-3(method='GET')
              .col-md-3
                label.form-label Estado
                select.form-select(name='estado')
                  option(value='' selected=!filtros.estado) Todos
                  option(value='Pendiente' selected=(filtros.estado === 'Pendiente')) Pendientes
                  option(value='Completado' selected=(filtros.estado === 'Completado')) Completados
              
              .col-md-3
                label.form-label Fecha Inicio
                input.form-control(type='date' name='fecha_inicio' value=filtros.fecha_inicio)
              
              .col-md-3
                label.form-label Fecha Fin
                input.form-control(type='date' name='fecha_fin' value=filtros.fecha_fin)
              
              .col-md-3
                label.form-label Buscar Paciente
                input.form-control(type='text' name='paciente' placeholder='Nombre, apellido o DNI' value=filtros.paciente)
              
              .col-12.d-flex.justify-content-end
                button.btn.btn-primary.me-2(type='submit')
                  i.fas.fa-filter.me-2
                  | Filtrar
                button.btn.btn-secondary(type='button' onclick='limpiarFiltros()')
                  i.fas.fa-times.me-2
                  | Limpiar

    // Tabla de procedimientos
    .row
      .col-12
        .card.border-0.shadow-sm
          .card-header.bg-white
            h5.mb-0
              i.fas.fa-list.me-2
              | Procedimientos Pre-quirúrgicos
          .card-body.p-0
            if procedimientos.length > 0
              .table-responsive
                table.table.table-hover.mb-0#tabla-prequirurgicos
                  thead.table-light
                    tr
                      th Estado
                      th Paciente
                      th DNI
                      th Procedimiento
                      th Médico
                      th Fecha Solicitud
                      th Enfermero
                      th.text-center Acciones
                  tbody
                    each proc in procedimientos
                      tr(class=proc.estado === 'Pendiente' ? 'table-warning' : '')
                        td
                          if proc.estado === 'Pendiente'
                            span.badge.bg-warning.text-dark
                              i.fas.fa-clock.me-1
                              | Pendiente
                          else
                            span.badge.bg-success
                              i.fas.fa-check.me-1
                              | Completado
                        td
                          strong= `${proc.evaluacion_medica.paciente.usuario.nombre} ${proc.evaluacion_medica.paciente.usuario.apellido}`
                        td
                          small.text-muted= proc.evaluacion_medica.paciente.usuario.dni
                        td
                          strong= proc.nombre
                          if proc.descripcion
                            br
                            small.text-muted= proc.descripcion.substring(0, 50) + '...'
                        td
                          small Dr. #{proc.evaluacion_medica.medico.usuario.nombre} #{proc.evaluacion_medica.medico.usuario.apellido}
                        td
                          small= new Date(proc.created_at).toLocaleDateString('es-AR')
                        td
                          if proc.evaluacion_enfermeria
                            small= `${proc.evaluacion_enfermeria.enfermero.usuario.nombre} ${proc.evaluacion_enfermeria.enfermero.usuario.apellido}`
                          else
                            small.text-muted No asignado
                        td.text-center
                          .btn-group.btn-group-sm(role='group')
                            a.btn.btn-outline-info(href=`/enfermero/prequirurgicos/${proc.id}` title='Ver detalle')
                              i.fas.fa-eye
                            if proc.estado === 'Pendiente'
                              a.btn.btn-success(href=`/enfermero/prequirurgicos/${proc.id}/completar` title='Completar')
                                i.fas.fa-check
                            button.btn.btn-outline-danger(onclick=`registrarComplicacion(${proc.id})` title='Reportar complicación')
                              i.fas.fa-exclamation-triangle
            else
              .p-5.text-center.text-muted
                i.fas.fa-clipboard-check.fa-4x.mb-3
                h5 No hay procedimientos pre-quirúrgicos
                p.mb-0 Utilice los filtros para buscar

    // Modal para pendientes
    #modalPendientes.modal.fade(tabindex='-1')
      .modal-dialog.modal-xl
        .modal-content
          .modal-header.bg-danger.text-white
            h5.modal-title
              i.fas.fa-exclamation-triangle.me-2
              | Preparaciones Pre-quirúrgicas Pendientes
            button.btn-close.btn-close-white(data-bs-dismiss='modal')
          .modal-body
            #contenido-pendientes
              .text-center
                .spinner-border.text-primary(role='status')
                  span.visually-hidden Cargando...

    // Modal para complicación
    #modalComplicacion.modal.fade(tabindex='-1')
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title
              i.fas.fa-exclamation-triangle.me-2
              | Reportar Complicación
            button.btn-close(data-bs-dismiss='modal')
          .modal-body
            form#form-complicacion
              input(type='hidden' id='complicacion-proc-id')
              
              .mb-3
                label.form-label Tipo de Complicación
                select.form-select(id='tipo-complicacion' required)
                  option(value='') Seleccionar
                  option(value='Paciente no cumplió ayuno') Paciente no cumplió ayuno
                  option(value='Estudios incompletos') Estudios incompletos
                  option(value='Consentimiento no firmado') Consentimiento no firmado
                  option(value='Condición médica nueva') Condición médica nueva detectada
                  option(value='Alergia no documentada') Alergia no documentada
                  option(value='Otro') Otro
              
              .mb-3
                label.form-label Descripción Detallada
                textarea.form-control(id='desc-complicacion' rows='4' required)
              
              .mb-3
                .form-check
                  input.form-check-input(type='checkbox' id='requiere-suspension')
                  label.form-check-label(for='requiere-suspension')
                    strong.text-danger ¿Requiere suspensión de la cirugía?
          
          .modal-footer
            button.btn.btn-secondary(data-bs-dismiss='modal') Cancelar
            button.btn.btn-danger(onclick='guardarComplicacion()') Reportar

block scripts
  script(src='/js/enfermero/prequirurgicos.js')