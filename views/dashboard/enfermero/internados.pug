extends ../../layouts/enfermero-layout

block content
  .container-fluid
    // Header
    .row.mb-4
      .col-12
        .d-flex.justify-content-between.align-items-center
          div
            h2.mb-1
              i.fas.fa-bed.me-2
              | Pacientes Internados
            p.text-muted.mb-0 Monitoreo de pacientes hospitalizados
          div
            button.btn.btn-outline-primary(onclick='actualizarEstadisticas()')
              i.fas.fa-sync-alt.me-2
              | Actualizar

    // Estadísticas
    .row.g-3.mb-4
      .col-md-2.col-sm-4.col-6
        .card.border-0.shadow-sm.text-center
          .card-body
            h3.mb-0= estadisticas.total
            small.text-muted Total
      
      .col-md-2.col-sm-4.col-6
        .card.border-0.shadow-sm.border-start.border-danger.border-4.text-center
          .card-body
            h3.mb-0.text-danger= estadisticas.criticos
            small.text-muted Críticos
      
      .col-md-2.col-sm-4.col-6
        .card.border-0.shadow-sm.border-start.border-warning.border-4.text-center
          .card-body
            h3.mb-0.text-warning= estadisticas.graves
            small.text-muted Graves
      
      .col-md-2.col-sm-4.col-6
        .card.border-0.shadow-sm.border-start.border-success.border-4.text-center
          .card-body
            h3.mb-0.text-success= estadisticas.estables
            small.text-muted Estables
      
      .col-md-2.col-sm-4.col-6
        .card.border-0.shadow-sm.border-start.border-info.border-4.text-center
          .card-body
            h3.mb-0.text-info= estadisticas.prequirurgicos
            small.text-muted Pre-quirúrgicos

    // Filtros
    .row.mb-3
      .col-12
        .card.border-0.shadow-sm
          .card-body
            form#form-filtros.row.g-3(method='GET')
              .col-md-3
                label.form-label Sector
                select.form-select(name='sector' id='filtro-sector')
                  option(value='' selected=!filtros.sector) Todos
                  each sector in sectores
                    option(value=sector.id selected=(filtros.sector == sector.id))= sector.nombre
              
              .col-md-3
                label.form-label Estado del Paciente
                select.form-select(name='estado_paciente')
                  option(value='' selected=!filtros.estado_paciente) Todos
                  option(value='Critico' selected=(filtros.estado_paciente === 'Critico')) Crítico
                  option(value='Grave' selected=(filtros.estado_paciente === 'Grave')) Grave
                  option(value='Estable' selected=(filtros.estado_paciente === 'Estable')) Estable
                  option(value='Sin_Evaluar' selected=(filtros.estado_paciente === 'Sin_Evaluar')) Sin Evaluar
              
              .col-md-3
                label.form-label Habitación
                select.form-select(name='habitacion')
                  option(value='' selected=!filtros.habitacion) Todas
                  each hab in habitaciones
                    option(value=hab.id selected=(filtros.habitacion == hab.id))= `${hab.numero} (${hab.sector.nombre})`
              
              .col-md-3
                label.form-label Buscar Paciente
                input.form-control(type='text' name='busqueda' placeholder='Nombre o DNI' value=filtros.busqueda)
              
              .col-12.d-flex.justify-content-end
                button.btn.btn-primary.me-2(type='submit')
                  i.fas.fa-filter.me-2
                  | Filtrar
                button.btn.btn-secondary(type='button' onclick='limpiarFiltros()')
                  i.fas.fa-times.me-2
                  | Limpiar

    // Tabla de internados
    .row
      .col-12
        .card.border-0.shadow-sm
          .card-header.bg-white
            h5.mb-0
              i.fas.fa-list.me-2
              | Pacientes Hospitalizados
          .card-body.p-0
            if internaciones.length > 0
              .table-responsive
                table.table.table-hover.mb-0#tabla-internados
                  thead.table-light
                    tr
                      th Estado
                      th Paciente
                      th DNI
                      th Ubicación
                      th Médico
                      th Tipo
                      th Días Int.
                      th Última Eval.
                      th.text-center Acciones
                  tbody
                    each internacion in internaciones
                      - const rowClass = internacion.estado_paciente === 'Critico' ? 'table-danger' : internacion.estado_paciente === 'Grave' ? 'table-warning' : ''
                      tr(class=rowClass)
                        td
                          case internacion.estado_paciente
                            when 'Critico'
                              span.badge.bg-danger
                                i.fas.fa-exclamation-triangle.me-1
                                | Crítico
                            when 'Grave'
                              span.badge.bg-warning.text-dark
                                i.fas.fa-exclamation-circle.me-1
                                | Grave
                            when 'Estable'
                              span.badge.bg-success
                                i.fas.fa-check.me-1
                                | Estable
                            when 'Sin_Evaluar'
                              span.badge.bg-secondary Sin Evaluar
                            when 'Fallecido'
                              span.badge.bg-dark Fallecido
                        td
                          strong= `${internacion.paciente.usuario.nombre} ${internacion.paciente.usuario.apellido}`
                          if internacion.estado_operacion === 'Prequirurgico'
                            br
                            span.badge.bg-info
                              i.fas.fa-scalpel.me-1
                              | Pre-quirúrgico
                        td
                          small.text-muted= internacion.paciente.usuario.dni
                        td
                          strong Hab. #{internacion.cama.habitacion.numero}
                          br
                          small.text-muted Cama #{internacion.cama.numero}
                          br
                          small.text-muted= internacion.cama.habitacion.sector.nombre
                        td
                          small Dr. #{internacion.medico.usuario.nombre} #{internacion.medico.usuario.apellido}
                        td
                          small= internacion.tipoInternacion.nombre
                        td
                          span.badge.bg-info= `${internacion.dias_internado} días`
                        td
                          if internacion.ultima_evaluacion
                            small= new Date(internacion.ultima_evaluacion.fecha).toLocaleString('es-AR')
                            br
                            small.text-muted= internacion.ultima_evaluacion.enfermero.usuario.nombre
                          else
                            small.text-muted Sin evaluación
                        td.text-center
                          .btn-group.btn-group-sm(role='group')
                            a.btn.btn-outline-info(href=`/enfermero/internados/${internacion.id}` title='Ver detalle')
                              i.fas.fa-eye
                            button.btn.btn-outline-primary(onclick=`registrarEvolucion(${internacion.id})` title='Evolución')
                              i.fas.fa-notes-medical
                            button.btn.btn-outline-warning(onclick=`cambiarEstado(${internacion.id})` title='Cambiar estado')
                              i.fas.fa-edit
            else
              .p-5.text-center.text-muted
                i.fas.fa-bed.fa-4x.mb-3
                h5 No hay pacientes internados
                p.mb-0 No se encontraron pacientes con los filtros aplicados

    // Modal cambiar estado
    #modalCambiarEstado.modal.fade(tabindex='-1')
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title
              i.fas.fa-edit.me-2
              | Cambiar Estado del Paciente
            button.btn-close(data-bs-dismiss='modal')
          .modal-body
            form#form-cambiar-estado
              input(type='hidden' id='estado-internacion-id')
              
              .mb-3
                label.form-label Estado del Paciente
                select.form-select(id='nuevo-estado' required)
                  option(value='') Seleccionar
                  option(value='Estable') Estable
                  option(value='Grave') Grave
                  option(value='Critico') Crítico
                  option(value='Sin_Evaluar') Sin Evaluar
              
              .mb-3
                label.form-label Observaciones
                textarea.form-control(id='estado-observaciones' rows='4' required placeholder='Describa el motivo del cambio de estado...')
          
          .modal-footer
            button.btn.btn-secondary(data-bs-dismiss='modal') Cancelar
            button.btn.btn-primary(onclick='guardarEstado()') Guardar

    // Modal evolución
    #modalEvolucion.modal.fade(tabindex='-1')
      .modal-dialog.modal-lg
        .modal-content
          .modal-header
            h5.modal-title
              i.fas.fa-notes-medical.me-2
              | Registrar Evolución de Enfermería
            button.btn-close(data-bs-dismiss='modal')
          .modal-body
            form#form-evolucion
              input(type='hidden' id='evolucion-internacion-id')
              
              .mb-3
                label.form-label Signos Vitales *
                textarea.form-control(id='evol-signos-vitales' rows='2' required placeholder='PA: 120/80, FC: 70 lpm, T: 36.5°C, SpO2: 98%')
              
              .mb-3
                label.form-label Observaciones Generales *
                textarea.form-control(id='evol-observaciones' rows='3' required placeholder='Estado general del paciente...')
              
              .mb-3
                label.form-label Procedimientos Realizados
                textarea.form-control(id='evol-procedimientos' rows='2' placeholder='Curaciones, aspiraciones, etc.')
              
              .mb-3
                label.form-label Medicación Administrada
                textarea.form-control(id='evol-medicacion' rows='2' placeholder='Medicamentos administrados durante el turno...')
              
              .mb-3
                label.form-label Cambios Notables
                textarea.form-control(id='evol-cambios' rows='3' placeholder='Cualquier cambio significativo en el estado del paciente...')
                small.form-text.text-danger Si hay cambios importantes, se notificará al médico
          
          .modal-footer
            button.btn.btn-secondary(data-bs-dismiss='modal') Cancelar
            button.btn.btn-primary(onclick='guardarEvolucion()') Registrar Evolución

block scripts
  script(src='/js/enfermero/internados.js')