extends ../layout

block content
  .container-fluid
    .row
      .col-md-12
        .d-flex.justify-content-between.align-items-center.mb-4
          h2
            i.fas.fa-list-alt.me-2
            | Lista de Admisiones
          a.btn.btn-primary(href='/admisiones')
            i.fas.fa-plus.me-2
            | Nueva Admisión

    //- FILTROS
    .row.mb-4
      .col-md-12
        .card
          .card-header
            h5.mb-0
              i.fas.fa-filter.me-2
              | Filtros
          .card-body
            form#formFiltros(method='GET')
              .row
                .col-md-3
                  label.form-label(for='filtro_estado') Estado
                  select#filtro_estado.form-select(name='estado')
                    option(value='') Todos
                    option(value='Pendiente' selected=(filtros && filtros.estado === 'Pendiente')) Pendiente
                    option(value='Completada' selected=(filtros && filtros.estado === 'Completada')) Completada
                    option(value='Cancelada' selected=(filtros && filtros.estado === 'Cancelada')) Cancelada
                
                .col-md-3
                  label.form-label(for='filtro_desde') Desde
                  input#filtro_desde.form-control(type='date' name='desde' value=filtros && filtros.desde)
                
                .col-md-3
                  label.form-label(for='filtro_hasta') Hasta
                  input#filtro_hasta.form-control(type='date' name='hasta' value=filtros && filtros.hasta)
                
                .col-md-3
                  label.form-label(for='filtro_dni') DNI Paciente
                  input#filtro_dni.form-control(type='text' name='paciente_dni' placeholder='12345678' value=filtros && filtros.paciente_dni)
              
              .row.mt-3
                .col-md-12
                  button.btn.btn-primary(type='submit')
                    i.fas.fa-search.me-2
                    | Buscar
                  button.btn.btn-secondary.ms-2(type='button' onclick="window.location.href='/admisiones/lista'")
                    i.fas.fa-times.me-2
                    | Limpiar

    //- TABLA DE ADMISIONES
    .row
      .col-md-12
        .card
          .card-body
            if admisiones && admisiones.length > 0
              .table-responsive
                table.table.table-hover.table-striped
                  thead
                    tr
                      th ID
                      th Paciente (DNI)
                      th Fecha
                      th Motivo
                      th Forma Ingreso
                      th Médico
                      th Estado
                      th Acciones
                  tbody
                    each admision in admisiones
                      tr(data-admision-id=admision.id)
                        td= admision.id
                        td
                          strong= `${admision.paciente.usuario.nombre} ${admision.paciente.usuario.apellido}`
                          br
                          small.text-muted DNI: #{admision.paciente.usuario.dni}
                        td= new Date(admision.fecha).toLocaleDateString('es-AR')
                        td= admision.motivo.nombre
                        td= admision.forma_ingreso.nombre
                        td
                          if admision.medico
                            = `Dr/a. ${admision.medico.usuario.nombre} ${admision.medico.usuario.apellido}`
                          else
                            span.text-muted Sin asignar
                        td
                          if admision.estado === 'Pendiente'
                            span.badge.bg-warning.text-dark Pendiente
                          else if admision.estado === 'Completada'
                            span.badge.bg-success Completada
                          else if admision.estado === 'Cancelada'
                            span.badge.bg-danger Cancelada
                        td
                          .btn-group(role='group')
                            button.btn.btn-sm.btn-info.btn-ver-detalle(type='button' data-id=admision.id title='Ver Detalle')
                              i.fas.fa-eye
                            if admision.estado === 'Pendiente'
                              button.btn.btn-sm.btn-success.btn-completar(type='button' data-id=admision.id title='Completar')
                                i.fas.fa-check
                              button.btn.btn-sm.btn-danger.btn-cancelar(type='button' data-id=admision.id title='Cancelar')
                                i.fas.fa-times

              //- PAGINACIÓN
              if pagination && pagination.totalPages > 1
                nav.mt-4(aria-label='Paginación')
                  ul.pagination.justify-content-center
                    //- Anterior
                    li.page-item(class=pagination.currentPage === 1 ? 'disabled' : '')
                      a.page-link(href=`?page=${pagination.currentPage - 1}&estado=${filtros && filtros.estado || ''}&desde=${filtros && filtros.desde || ''}&hasta=${filtros && filtros.hasta || ''}&paciente_dni=${filtros && filtros.paciente_dni || ''}`)
                        i.fas.fa-chevron-left
                    
                    //- Páginas
                    - var startPage = Math.max(1, pagination.currentPage - 2)
                    - var endPage = Math.min(pagination.totalPages, pagination.currentPage + 2)
                    
                    if startPage > 1
                      li.page-item
                        a.page-link(href=`?page=1&estado=${filtros && filtros.estado || ''}&desde=${filtros && filtros.desde || ''}&hasta=${filtros && filtros.hasta || ''}&paciente_dni=${filtros && filtros.paciente_dni || ''}`) 1
                      if startPage > 2
                        li.page-item.disabled
                          span.page-link ...
                    
                    - for (var i = startPage; i <= endPage; i++)
                      li.page-item(class=pagination.currentPage === i ? 'active' : '')
                        a.page-link(href=`?page=${i}&estado=${filtros && filtros.estado || ''}&desde=${filtros && filtros.desde || ''}&hasta=${filtros && filtros.hasta || ''}&paciente_dni=${filtros && filtros.paciente_dni || ''}`)= i
                    
                    if endPage < pagination.totalPages
                      if endPage < pagination.totalPages - 1
                        li.page-item.disabled
                          span.page-link ...
                      li.page-item
                        a.page-link(href=`?page=${pagination.totalPages}&estado=${filtros && filtros.estado || ''}&desde=${filtros && filtros.desde || ''}&hasta=${filtros && filtros.hasta || ''}&paciente_dni=${filtros && filtros.paciente_dni || ''}`)= pagination.totalPages
                    
                    //- Siguiente
                    li.page-item(class=pagination.currentPage === pagination.totalPages ? 'disabled' : '')
                      a.page-link(href=`?page=${pagination.currentPage + 1}&estado=${filtros && filtros.estado || ''}&desde=${filtros && filtros.desde || ''}&hasta=${filtros && filtros.hasta || ''}&paciente_dni=${filtros && filtros.paciente_dni || ''}`)
                        i.fas.fa-chevron-right
                
                .text-center.mt-2
                  small.text-muted
                    | Mostrando #{(pagination.currentPage - 1) * pagination.itemsPerPage + 1} - #{Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems)} de #{pagination.totalItems} registros

            else
              .alert.alert-warning
                i.fas.fa-exclamation-triangle.me-2
                | No se encontraron admisiones con los filtros aplicados

  //- MODAL: DETALLE DE ADMISIÓN
  #modalDetalleAdmision.modal.fade(tabindex='-1')
    .modal-dialog.modal-xl
      .modal-content
        .modal-header.bg-info.text-white
          h5.modal-title
            i.fas.fa-file-alt.me-2
            | Detalle de Admisión #
            span#detalle_admision_id
          button.btn-close(type='button' data-bs-dismiss='modal')
        .modal-body
          #contenido_detalle
            .text-center
              .spinner-border(role='status')
                span.visually-hidden Cargando...

block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      // Ver detalle
      document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.dataset.id;
          const modal = new bootstrap.Modal(document.getElementById('modalDetalleAdmision'));
          
          document.getElementById('detalle_admision_id').textContent = id;
          document.getElementById('contenido_detalle').innerHTML = `
            <div class="text-center">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
          `;
          
          modal.show();
          
          try {
            const response = await fetch(`/admisiones/api/${id}`);
            const data = await response.json();
            
            document.getElementById('contenido_detalle').innerHTML = `
              <div class="row">
                <div class="col-md-6">
                  <h5 class="mb-3"><i class="fas fa-user me-2"></i>Datos del Paciente</h5>
                  <p><strong>Nombre:</strong> ${data.paciente.usuario.nombre} ${data.paciente.usuario.apellido}</p>
                  <p><strong>DNI:</strong> ${data.paciente.usuario.dni}</p>
                  <p><strong>Email:</strong> ${data.paciente.usuario.email}</p>
                  <p><strong>Teléfono:</strong> ${data.paciente.usuario.telefono || 'No especificado'}</p>
                  <p><strong>Obra Social:</strong> ${data.paciente.obraSocial ? data.paciente.obraSocial.nombre : 'Sin obra social'}</p>
                </div>
                
                <div class="col-md-6">
                  <h5 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Datos de la Admisión</h5>
                  <p><strong>Fecha:</strong> ${new Date(data.fecha).toLocaleDateString('es-AR')}</p>
                  <p><strong>Estado:</strong> <span class="badge bg-${data.estado === 'Pendiente' ? 'warning text-dark' : data.estado === 'Completada' ? 'success' : 'danger'}">${data.estado}</span></p>
                  <p><strong>Motivo:</strong> ${data.motivo.nombre}</p>
                  <p><strong>Forma de Ingreso:</strong> ${data.forma_ingreso.nombre}</p>
                  ${data.medico ? `<p><strong>Médico:</strong> Dr/a. ${data.medico.usuario.nombre} ${data.medico.usuario.apellido}</p>` : ''}
                  ${data.especialidad ? `<p><strong>Especialidad:</strong> ${data.especialidad.nombre}</p>` : ''}
                  ${data.sector ? `<p><strong>Sector:</strong> ${data.sector.nombre}</p>` : ''}
                </div>
              </div>
              
              ${data.turno ? `
                <hr>
                <div class="row">
                  <div class="col-md-12">
                    <h5 class="mb-3"><i class="fas fa-calendar-check me-2"></i>Turno Asignado</h5>
                    <p><strong>Fecha:</strong> ${new Date(data.turno.fecha).toLocaleDateString('es-AR')}</p>
                    <p><strong>Hora:</strong> ${data.turno.hora_inicio}</p>
                    <p><strong>Estado:</strong> <span class="badge bg-info">${data.turno.estado}</span></p>
                  </div>
                </div>
              ` : ''}
              
              ${data.internacion ? `
                <hr>
                <div class="row">
                  <div class="col-md-12">
                    <h5 class="mb-3"><i class="fas fa-bed me-2"></i>Internación</h5>
                    <p><strong>Habitación:</strong> ${data.internacion.habitacion.numero}</p>
                    <p><strong>Cama:</strong> ${data.internacion.cama.numero}</p>
                    <p><strong>Tipo:</strong> ${data.internacion.tipoInternacion.nombre}</p>
                  </div>
                </div>
              ` : ''}
            `;
          } catch (error) {
            document.getElementById('contenido_detalle').innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error al cargar los detalles
              </div>
            `;
          }
        });
      });
      
      // Completar admisión
      document.querySelectorAll('.btn-completar').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.dataset.id;
          
          if (confirm('¿Confirmar completar esta admisión?')) {
            try {
              const response = await fetch(`/admisiones/api/${id}/estado`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: 'Completada' })
              });
              
              const data = await response.json();
              
              if (data.success) {
                alert('✅ Admisión completada exitosamente');
                location.reload();
              } else {
                alert('❌ Error: ' + data.message);
              }
            } catch (error) {
              alert('❌ Error al completar admisión');
            }
          }
        });
      });
      
      // Cancelar admisión
      document.querySelectorAll('.btn-cancelar').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.dataset.id;
          
          const motivo = prompt('Ingrese el motivo de la cancelación:');
          if (motivo) {
            try {
              const response = await fetch(`/admisiones/api/${id}/estado`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  estado: 'Cancelada',
                  observaciones: `Cancelada: ${motivo}`
                })
              });
              
              const data = await response.json();
              
              if (data.success) {
                alert('✅ Admisión cancelada exitosamente');
                location.reload();
              } else {
                alert('❌ Error: ' + data.message);
              }
            } catch (error) {
              alert('❌ Error al cancelar admisión');
            }
          }
        });
      });
    });
