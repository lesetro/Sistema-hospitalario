extends layout.pug

block content
  .container.mt-4
    .row
      // Sección: Lista de Pacientes
      .col-md-12
        .card.mb-4
          .card-header
            h5.mb-0
              i.fas.fa-users.me-2
              | Lista de Pacientes
          .card-body
            a.btn.btn-primary.mb-3(href='/pacientes/new') Nuevo Paciente
            .table-responsive
              table.table.table-striped
                thead
                  tr
                    th DNI
                    th Nombre
                    th Correo
                    th Acciones
                tbody
                  each paciente in pacientes
                    tr
                      td= paciente.dni
                      td= paciente.nombre
                      td= paciente.email
                      td
                        a.btn.btn-info.btn-sm(href=`/pacientes/${paciente.id}`) Ver
                        a.btn.btn-warning.btn-sm.mx-2(href=`/pacientes/${paciente.id}/edit`) Editar
                        form(method='POST' action=`/pacientes/${paciente.id}` style='display:inline;')
                          input(type='hidden' name='_method' value='DELETE')
                          button.btn.btn-danger.btn-sm(type='submit') Eliminar

      // Sección: Listado de Admisiones
      .col-md-12
        .card.mb-4
          .card-header
            h5.mb-0
              i.fas.fa-list.me-2
              | Listado de Admisiones
          .card-body.bg-light.p-3
            // Filtros
            .row.mb-3
              .col-md-3
                label.form-label(for='filtro_estado') Estado
                select#filtro_estado.form-select
                  option(value='') Todos
                  option(value='Pendiente') Pendiente
                  option(value='Cancelada') Cancelada
                  option(value='Completada') Completada
              .col-md-3
                label.form-label(for='filtro_paciente') Paciente
                input#filtro_paciente.form-control(type='text' placeholder='Nombre o DNI')
              .col-md-3
                label.form-label(for='filtro_fecha') Fecha
                input#filtro_fecha.form-control(type='date')
              .col-md-3
                label.form-label(for='filtro_motivo') Motivo
                select#filtro_motivo.form-select
                  option(value='') Todos
                  if motivos && Array.isArray(motivos) && motivos.length
                    each motivo in motivos
                      option(value=motivo.id)= motivo.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay motivos disponibles
            
            // Tabla de Admisiones
            .table-responsive
              table.table.table-hover
                thead
                  tr
                    th ID
                    th Paciente
                    th Administrativo
                    th Estado
                    th Fecha
                    th Motivo
                    th Forma de Ingreso
                    th Turno
                    th Médico
                    th Sector
                    th Lista de Espera
                    th Acciones
                tbody
                  if admisiones && Array.isArray(admisiones) && admisiones.length
                    each admision in admisiones
                      tr
                        td= admision.id || 'N/A'
                        td
                          if admision.paciente && admision.paciente.usuario
                            | #{admision.paciente.usuario.nombre || 'N/A'} #{admision.paciente.usuario.apellido || 'N/A'}
                          else
                            | Sin paciente
                        td
                          if admision.administrativo
                            | #{admision.administrativo.responsabilidad || 'N/A'}
                          else
                            | Sin administrativo
                        td= admision.estado || 'N/A'
                        td= admision.fecha || 'N/A'
                        td
                          if admision.motivo
                            | #{admision.motivo.nombre || 'N/A'}
                          else
                            | N/A
                        td
                          if admision.forma_ingreso
                            | #{admision.forma_ingreso.nombre || 'N/A'}
                          else
                            | N/A
                        td
                          if admision.turno
                            | #{admision.turno.fecha || 'N/A'} #{admision.turno.hora_inicio || 'N/A'}
                          else
                            | N/A
                        td
                          if admision.medico && admision.medico.usuario
                            | #{admision.medico.usuario.nombre || 'N/A'} #{admision.medico.usuario.apellido || 'N/A'}
                          else
                            | N/A
                        td
                          if admision.sector
                            | #{admision.sector.nombre || 'N/A'}
                          else
                            | N/A
                        td
                          if admision.turno && admision.turno.listaEsperaTurno
                            | #{admision.turno.listaEsperaTurno.tipo || 'N/A'} (Prioridad: #{admision.turno.listaEsperaTurno.prioridad || 'N/A'})
                          else
                            | N/A
                        td
                          button.btn.btn-primary.btn-sm.me-2(data-bs-toggle='modal' data-bs-target='#edit_editarAdmisionModal' data-id=admision.id) Editar
                          button.btn.btn-outline-danger.btn-sm(data-id=admision.id) Eliminar
                  else
                    tr
                      td.text-center.text-warning(colspan='12')
                        | No hay admisiones disponibles.
                        a.btn.btn-primary.btn-sm.ms-2(href='/admisiones/nueva') Agregar nueva admisión

  // Modal para editar admisión
  .modal.fade(id='edit_editarAdmisionModal' tabindex='-1' aria-labelledby='edit_editarAdmisionModalLabel' aria-hidden='true')
    .modal-dialog.modal-lg
      .modal-content
        .modal-header(style='background: linear-gradient(135deg, #a5c2b3ff 0%, #2575fc 100%); color: white;')
          h5.modal-title(id='edit_editarAdmisionModalLabel') Editar Admisión
          button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
        .modal-body
          form#editarAdmisionForm
            input(type='hidden' name='edit_id')
            .mb-3
              label.form-label(for='edit_paciente_id') 
                strong Paciente ID: 
                span#edit_span_paciente_id.text-muted (Cargando...)
            .row.mb-3
              .col-md-4.mb-3
                label.form-label(for='edit_nombre_id') Nombre *
                input#edit_nombre_id.form-control(type='text' name='edit_nombre_id' required)
              .col-md-4.mb-3
                label.form-label(for='edit_apellido_id') Apellido *
                input#edit_apellido_id.form-control(type='text' name='edit_apellido_id' required)
              .col-md-4.mb-3
                label.form-label(for='edit_dni_id') DNI *
                input#edit_dni_id.form-control(type='text' name='edit_dni_id' required)
            
            .row.mb-3
              .col-md-6.mb-3
                label.form-label(for='edit_administrativo_id') Administrativo Responsable *
                select#edit_administrativo_id.form-select(name='edit_administrativo_id' required)
                  option(value='') Seleccione un administrativo
                  if administrativos && Array.isArray(administrativos) && administrativos.length
                    each administrativo in administrativos
                      option(value=administrativo.id)= administrativo.nombre || administrativo.responsabilidad || 'N/A'
                  else
                    option(value='' disabled) No hay administrativos disponibles
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_motivo_id') Motivo de Admisión *
                select#edit_motivo_id.form-select(name='edit_motivo_id' required)
                  option(value='') Seleccione un motivo
                  if motivos && Array.isArray(motivos) && motivos.length
                    each motivo in motivos
                      option(value=motivo.id)= motivo.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay motivos disponibles
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_forma_ingreso_id') Forma de Ingreso *
                select#edit_forma_ingreso_id.form-select(name='edit_forma_ingreso_id' required)
                  option(value='') Seleccione una forma
                  if formas && Array.isArray(formas) && formas.length
                    each forma in formas
                      option(value=forma.id)= forma.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay formas disponibles
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_medico_id') Médico *
                select#edit_medico_id.form-select(name='edit_medico_id' required)
                  option(value='') Seleccione un médico
                  if medicos && medicos.length
                    each medico in medicos
                      option(value=medico.id)= `${medico.usuario.nombre} ${medico.usuario.apellido}`
                  else
                    option(value='' disabled) No hay médicos disponibles
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_fecha_admision') Fecha de Admisión *
                input#edit_fecha_admision.form-control(type='date' name='edit_fecha' required)
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_tipo_turno_id') Tipo de Turno *
                select#edit_tipo_turno_id.form-select(name='edit_tipo_turno_id' required)
                  option(value='') Seleccione un tipo
                  if tiposTurno && Array.isArray(tiposTurno) && tiposTurno.length
                    each tipo in tiposTurno
                      option(value=tipo.id)= tipo.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay tipos de turno disponibles
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_sector_id') Sector *
                select#edit_sector_id.form-select(name='edit_sector_id' required)
                  option(value='') Seleccione un sector
                  if sectores && Array.isArray(sectores) && sectores.length
                    each sector in sectores
                      option(value=sector.id)= sector.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay sectores disponibles
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_turno_fecha') Fecha del Turno *
                input#edit_turno_fecha.form-control(type='date' name='edit_turno_fecha' required)
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_turno_hora') Hora del Turno *
                select#edit_turno_hora.form-select(name='edit_turno_hora' required)
                  option(value='') Seleccione un horario
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_lista_espera_tipo') Tipo de Lista de Espera *
                select#edit_lista_espera_tipo.form-select(name='edit_lista_espera_tipo' required)
                  option(value='') Seleccione un tipo
                  option(value='ESTUDIO') Estudio
                  option(value='EVALUACION') Evaluación
                  option(value='INTERNACION') Internación
                  option(value='CIRUGIA') Cirugía
                .error-message.text-danger(style='display: none;') Campo requerido
              
              .col-md-6.mb-3
                label.form-label(for='edit_tipo_estudio_id') Tipo de Estudio
                select#edit_tipo_estudio_id.form-select(name='edit_tipo_estudio_id')
                  option(value='') Seleccione un tipo (opcional)
                  if tiposEstudio && Array.isArray(tiposEstudio) && tiposEstudio.length
                    each tipo in tiposEstudio
                      option(value=tipo.id)= tipo.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay tipos de estudio disponibles
              
              .col-md-6.mb-3
                label.form-label(for='edit_especialidad_id') Especialidad
                select#edit_especialidad_id.form-select(name='edit_especialidad_id')
                  option(value='') Seleccione una especialidad (opcional)
                  if especialidades && Array.isArray(especialidades) && especialidades.length
                    each especialidad in especialidades
                      option(value=especialidad.id)= especialidad.nombre || 'N/A'
                  else
                    option(value='' disabled) No hay especialidades disponibles
              
              .col-md-6.mb-3
                label.form-label(for='edit_prioridad') Prioridad *
                select#edit_prioridad.form-select(name='edit_prioridad' required)
                  option(value='') Seleccione prioridad
                  option(value='1') Alta
                  option(value='2') Media
                  option(value='3') Baja
                .error-message.text-danger(style='display: none;') Campo requerido
            
            .d-grid
              button.btn.btn-primary.btn-lg(type='submit') Guardar Cambios

  // Scripts
  script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js')
  script(src='/js/paciente.js')